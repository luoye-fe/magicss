/*
 * Magicss v1.0.0
 * (c) 2016 luoye <842891024@qq.com>
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Magicss=e()}(this,function(){"use strict";function t(t){function e(e){return c=e?c+e:++c,l=t.charAt(c),l||""}function n(){return t.charAt(c+1)||""}function r(){var n=t.substr(c),r=n.match(h.comment)[0];for(e(r.length);/\s|\n/.test(l);)r+=l,e();var i={};if(h.ruleOptionInComment.test(r)){var o=r.match(h.ruleOptionInComment)[1];i=a(o)}s.push({type:"comment",comment:r.replace(h.ruleOptionInComment,""),options:i})}function i(){var n=t.substr(c),r=n.match(h.selector)[1];e(r.length);var i=o();s.push({type:"common",selector:r.replace(h.bothWhiteSpace,""),options:i.options,style:i.style})}function o(){var n=t.substr(c),r=n.match(h.allRules)[1],i={},o={};if(e(r.length),h.comment.test(r)){var s=r.match(h.comment)[0].replace(h.whiteSpace,"").replace(h.commentFlag,"").replace(/\n/g,"");i=a(s)}var u=r.replace(h.comment,"").replace(/\n/g,"").replace(/\{|\}/g,"");return o=a(u),{options:i,style:o}}function a(t){var e={},n=u(t,";");return n.forEach(function(t){var n=u(t,":");e[n[0].replace(h.bothWhiteSpace,"")]=n[1].replace(h.bothWhiteSpace,"")}),e}var s=[];t=t||"",t=t.replace(/\r\n|[\r\u2028\u2029]/g,"\n");var c=-1,l=void 0,h={};h.comment=/\/\*[\s\S]+?\*\/|\/\/.+?\n/,h.commentFlag=/\/\/|\/\*|\*\//g,h.ruleOptionInComment=/\{\{(.+?)\}\}/,h.bothWhiteSpace=/^\s+|\s+$/,h.whiteSpace=/\s/g,h.selector=/([\s\S]+?)\{/,h.allRules=/(\{[\s\S]+?\})/;var f=["a","abbr","acronym","address","applet","area","article","aside","audio","b","base","basefont","bdi","bdo","bgsound","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","command","content","data","datalist","dd","del","details","dfn","dialog","dir","div","dl","dt","element","em","embed","fieldset","figcaption","figure","font","footer","form","frame","frameset","head","header","hgroup","hr","html","i","iframe","image","img","input","ins","isindex","kbd","keygen","label","legend","li","link","listing","main","map","mark","marquee","menu","menuitem","meta","meter","multicol","nav","nobr","noembed","noframes","noscript","object","ol","optgroup","option","output","p","param","picture","plaintext","pre","progress","q","rp","rt","rtc","ruby","s","samp","script","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","tt","u","ul","var","video","wbr","xmp"],p=["*",".","#","[",":"],d=[];for(d=[].concat(p),f.forEach(function(t){var e=t.substr(0,1);d.includes(e)||d.push(e)}),e();;){if(!l)break;"/"!==l||"*"!==n()&&"/"!==n()?d.includes(l)?i():e():r()}return s}function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var n,r=0;r<t.length;r++){var i=t[r];n=e.call(i,r,i)}return n}function r(t){return document.querySelector(t)}function i(t,e,n){var r=document.createElement(t),i=void 0;for(i in e)e.hasOwnProperty(i)&&r.setAttribute(i,e[i]);return n&&a(r,n),r}function o(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];n.forEach(function(e){t.appendChild(e)})}function a(t,e){s(e,0,t)}function s(t,e){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];r.forEach(function(n){e?"string"==typeof n.textContent?n.textContent=t:n.innerText=t:n.innerHTML=t})}function c(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var u=function(t,e){e=e||"";var n=t.split(e);return n[n.length-1].replace(/(^\s*)|(\s*$)/g,"").length||n.pop(),n},l=function(t){return new Promise(function(e,n){setTimeout(function(){e()},parseInt(t))})},h=function(t){return JSON.parse(JSON.stringify(t))},f=function(){return new Promise(function(t,e){t()})},p=function(t){return Object.prototype.toString.call(t).match(/\[object\s(.+?)]/)[1]},d=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),m=function(){function t(){e(this,t),this.cache={},this.offlineCache=[],this.isOne=!1}return d(t,[{key:"on",value:function(t,e){this.cache[t]?this.cache[t].push(e):(this.cache[t]=[],this.cache[t].push(e));var r=[];n(this.offlineCache,function(e,n){if(void 0!==n[t]){var i={};i[t]=n[t],r.push(i)}}),r.length>0&&(this.isOne?this.trigger(t,r[r.length-1][t]):n(r,function(e,n){this.trigger(t,n[t])}))}},{key:"one",value:function(t,e){this.isOne=!0,this.on(t,e),this.isOne=!1}},{key:"off",value:function(t,e){this.cache[t]&&(e?(e&&e(),this.cache[t]=[]):this.cache[t]=[]),this.offlineCache=[]}},{key:"trigger",value:function(t,e){var r=this.cache[t];if(!r||!r.length){var i={};return i[t]=e,void this.offlineCache.push(i)}return this.isOne?(r[0].call(this,e),void(this.cache[t]=[])):n(r,function(){return this.call(this,e)})}}]),t}(),v=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),g={speed:50,delay:0},y=new m,_=function(){function e(t){c(this,e),this.options=t||{},this.source=this.options.source||"",this.codeCon=this.options.codeCon||!1,this._paused=!1,this._status="nope",this._block=!1,this._formatedArray=[],this._index=0,this.format()}return v(e,[{key:"_assignPrintOption",value:function(t){return Object.assign(h(g),t)}},{key:"_handler",value:function(t){var e=this;return new Promise(function(n,r){"nope"===e._status&&n();var i=e._assignPrintOption(t.options);f().then(function(){return l(i.delay)}).then(function(){return e._print(t)}).then(function(){n()})})}},{key:"_applyStyle",value:function(t,e,n){r("#Magicss-style-con")||o(r("head"),i("style",{id:"Magicss-style-con"}));var s=r("#Magicss-style-con"),c=s.innerHTML;a(s,c+=t+"{"+e+":"+n+"}")}},{key:"_insertElement",value:function(t){var e=i("span",{class:t});return o(this.codeCon,e),e}},{key:"_print",value:function(t,e){var n=this;return this._onChange("processing",t),new Promise(function(e,r){"nope"===n._status&&e(),"comment"===t.type?!function(){var r=n._assignPrintOption(t.options);f().then(function(){var e=u(t.comment,""),i=n._insertElement("comment");return n._writeCharacterArrToEle(i,e,r.speed)}).then(function(){var t=["\n"],e=n.codeCon;return n._writeCharacterArrToEle(e,t,r.speed)}).then(function(){e()})}():"common"===t.type&&!function(){var r=n._assignPrintOption(t.options);f().then(function(){var e=u(t.selector,""),i=n._insertElement("selector");return n._writeCharacterArrToEle(i,e,r.speed)}).then(function(){var t=[" ","{","\n"],e=n.codeCon;return n._writeCharacterArrToEle(e,t,r.speed)}).then(function(){var e=Object.keys(t.style),i=0;return new Promise(function(o,a){var s=function a(){if(i>=e.length||"nope"===n._status)return void o();var s=n.codeCon;n._writeCharacterArrToEle(s,[" "," "," "," "],r.speed).then(function(){var t=u(e[i],""),o=n._insertElement("key");return n._writeCharacterArrToEle(o,t,r.speed)}).then(function(){return n._writeCharacterArrToEle(s,[":"," "],r.speed)}).then(function(){var o=u(t.style[e[i]],""),a=n._insertElement("value");return n._writeCharacterArrToEle(a,o,r.speed)}).then(function(){var o=e[i],a=t.style[e[i]];return n._writeCharacterArrToEle(s,[";","\n"],r.speed,t.selector,o,a)}).then(function(){i++,a()})};s()})}).then(function(){var t=["}","\n\n"],e=n.codeCon;return n._writeCharacterArrToEle(e,t,r.speed)}).then(function(){e()})}()})}},{key:"_writeCharacterArrToEle",value:function(t,e,n,r,i,o){var s=this;return new Promise(function(c,u){var h=function t(e,n,u){if(!n.length||"nope"===s._status)return void c();var h=e.innerHTML;f().then(function(){return l(u)}).then(function(){s._paused?t(e,n,u):("\n"===n[0]&&s._fixScrollTop(),r&&";"===n[0]&&s._applyStyle(r,i,o),a(e,h+=n[0]),n.splice(0,1),t(e,n,u))})};h(t,e,n)})}},{key:"_fixScrollTop",value:function(){var t=this.codeCon;t.scrollTop=t.scrollHeight}},{key:"_onChange",value:function(t,e){"Function"===p(this.options.onChange)&&this.options.onChange(t,e)}},{key:"_init",value:function(){var t=this;if(!this.codeCon)return void console.warn('You should give a real element to options of "codeCon".');if(0===this._index&&(this._status="start",this._block=!0,this._onChange("start")),"nope"===this._status)return this._index=0,this._block=!1,void y.trigger("nope");if(this._index>=this._formatedArray.length)return this._status="stop",this._block=!1,this._onChange("stop"),void(this._status="nope");var e=this._formatedArray[this._index];this._status="processing",this._handler(e).then(function(){t._index++,t._init()})}},{key:"init",value:function(){this._init()}},{key:"format",value:function(){return this._formatedArray=t(this.source),this._formatedArray}},{key:"setOptions",value:function(t){return this._block?void console.warn("Print process is running. Please wait it stop or apply stop func."):(this.constructor(t),void this.init())}},{key:"pause",value:function(){this._paused=!0}},{key:"continue",value:function(){this._paused=!1}},{key:"toggle",value:function(){this._paused=!this._paused}},{key:"stop",value:function(t){var e=this;return new Promise(function(n,r){e._block||("Function"===p(t)&&t(),n()),e._status="nope",y.on("nope",function(){"Function"===p(t)&&t(),y.off("nope"),n()})})}}]),e}();return _});