/*
 * Magicss v1.0.0
 * (c) 2016 luoye <842891024@qq.com>
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Magicss=e()}(this,function(){"use strict";function t(t){function e(e){return a=e?a+e:++a,h=t.charAt(a),h||""}function n(){return t.charAt(a+1)||""}function r(){var n=t.substr(a),r=n.match(l.comment)[0];for(e(r.length);/\s|\n/.test(h);)r+=h,e();var i={};if(l.ruleOptionInComment.test(r)){var o=r.match(l.ruleOptionInComment)[1];i=s(o)}c.push({type:"comment",comment:r.replace(l.ruleOptionInComment,""),options:i})}function i(){var n=t.substr(a),r=n.match(l.selector)[1];e(r.length);var i=o();c.push({type:"common",selector:r.replace(l.bothWhiteSpace,""),options:i.options,style:i.style})}function o(){var n=t.substr(a),r=n.match(l.allRules)[1],i={},o={};if(e(r.length),l.comment.test(r)){var c=r.match(l.comment)[0].replace(l.whiteSpace,"").replace(l.commentFlag,"").replace(/\n/g,"");i=s(c)}var u=r.replace(l.comment,"").replace(/\n/g,"").replace(/\{|\}/g,"");return o=s(u),{options:i,style:o}}function s(t){var e={},n=u(t,";");return n.forEach(function(t){var n=u(t,":");e[n[0].replace(l.bothWhiteSpace,"")]=n[1].replace(l.bothWhiteSpace,"")}),e}var c=[];t=t||"",t=t.replace(/\r\n|[\r\u2028\u2029]/g,"\n");var a=-1,h=void 0,l={};l.comment=/\/\*[\s\S]+?\*\/|\/\/.+?\n/,l.commentFlag=/\/\/|\/\*|\*\//g,l.ruleOptionInComment=/\{\{(.+?)\}\}/,l.bothWhiteSpace=/^\s+|\s+$/,l.whiteSpace=/\s/g,l.selector=/([\s\S]+?)\{/,l.allRules=/(\{[\s\S]+?\})/;var f=["*",".","#","[",":","a","b","c","d","e","f","h","i","k","l","m","n","o","p","q","r","s","t","u","v","w","x"];for(e();;){if(!h)break;"/"!==h||"*"!==n()&&"/"!==n()?f.includes(h)?i():e():r()}return c}function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var n,r=0;r<t.length;r++){var i=t[r];n=e.call(i,r,i)}return n}function r(t){return document.querySelector(t)}function i(t,e,n){var r=document.createElement(t),i=void 0;for(i in e)e.hasOwnProperty(i)&&r.setAttribute(i,e[i]);return n&&s(r,n),r}function o(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];n.forEach(function(e){t.appendChild(e)})}function s(t,e){c(e,0,t)}function c(t,e){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];r.forEach(function(n){e?"string"==typeof n.textContent?n.textContent=t:n.innerText=t:n.innerHTML=t})}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var u=function(t,e){e=e||"";var n=t.split(e);return n[n.length-1].replace(/(^\s*)|(\s*$)/g,"").length||n.pop(),n},h=function(t){return new Promise(function(e,n){setTimeout(function(){e()},parseInt(t))})},l=function(t){return JSON.parse(JSON.stringify(t))},f=function(){return new Promise(function(t,e){t()})},p=function(t){return Object.prototype.toString.call(t).match(/\[object\s(.+?)]/)[1]},v=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),m=function(){function t(){e(this,t),this.cache={},this.offlineCache=[],this.isOne=!1}return v(t,[{key:"on",value:function(t,e){this.cache[t]?this.cache[t].push(e):(this.cache[t]=[],this.cache[t].push(e));var r=[];n(this.offlineCache,function(e,n){if(void 0!==n[t]){var i={};i[t]=n[t],r.push(i)}}),r.length>0&&(this.isOne?this.trigger(t,r[r.length-1][t]):n(r,function(e,n){this.trigger(t,n[t])}))}},{key:"one",value:function(t,e){this.isOne=!0,this.on(t,e),this.isOne=!1}},{key:"off",value:function(t,e){this.cache[t]&&(e?(e&&e(),this.cache[t]=[]):this.cache[t]=[]),this.offlineCache=[]}},{key:"trigger",value:function(t,e){var r=this.cache[t];if(!r||!r.length){var i={};return i[t]=e,void this.offlineCache.push(i)}return this.isOne?(r[0].call(this,e),void(this.cache[t]=[])):n(r,function(){return this.call(this,e)})}}]),t}(),d=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),_={speed:50,delay:0},y=new m,g=function(){function e(t){a(this,e),this.options=t||{},this.source=this.options.source||"",this.codeCon=this.options.codeCon||!1,this._paused=!1,this._status="nope",this._block=!1,this._formatedArray=[],this._index=0,this.format()}return d(e,[{key:"_assignPrintOption",value:function(t){return Object.assign(l(_),t)}},{key:"_handler",value:function(t){var e=this;return new Promise(function(n,r){"nope"===e._status&&n();var i=e._assignPrintOption(t.options);f().then(function(){return h(i.delay)}).then(function(){return e._print(t)}).then(function(){n()})})}},{key:"_applyStyle",value:function(t,e,n){r("#Magicss-style-con")||o(r("head"),i("style",{id:"Magicss-style-con"}));var c=r("#Magicss-style-con"),a=c.innerHTML;s(c,a+=t+"{"+e+":"+n+"}")}},{key:"_insertElement",value:function(t){var e=i("span",{class:t});return o(this.codeCon,e),e}},{key:"_print",value:function(t,e){var n=this;return this._onChange("processing",t),new Promise(function(e,r){"nope"===n._status&&e(),"comment"===t.type?!function(){var r=n._assignPrintOption(t.options);f().then(function(){var e=u(t.comment,""),i=n._insertElement("comment");return n._writeCharacterArrToEle(i,e,r.speed)}).then(function(){var t=["\n"],e=n.codeCon;return n._writeCharacterArrToEle(e,t,r.speed)}).then(function(){e()})}():"common"===t.type&&!function(){var r=n._assignPrintOption(t.options);f().then(function(){var e=u(t.selector,""),i=n._insertElement("selector");return n._writeCharacterArrToEle(i,e,r.speed)}).then(function(){var t=[" ","{","\n"],e=n.codeCon;return n._writeCharacterArrToEle(e,t,r.speed)}).then(function(){var e=Object.keys(t.style),i=0;return new Promise(function(o,s){var c=function s(){if(i>=e.length||"nope"===n._status)return void o();var c=n.codeCon;n._writeCharacterArrToEle(c,[" "," "," "," "],r.speed).then(function(){var t=u(e[i],""),o=n._insertElement("key");return n._writeCharacterArrToEle(o,t,r.speed)}).then(function(){return n._writeCharacterArrToEle(c,[":"," "],r.speed)}).then(function(){var o=u(t.style[e[i]],""),s=n._insertElement("value");return n._writeCharacterArrToEle(s,o,r.speed)}).then(function(){var o=e[i],s=t.style[e[i]];return n._writeCharacterArrToEle(c,[";","\n"],r.speed,t.selector,o,s)}).then(function(){i++,s()})};c()})}).then(function(){var t=["}","\n\n"],e=n.codeCon;return n._writeCharacterArrToEle(e,t,r.speed)}).then(function(){e()})}()})}},{key:"_writeCharacterArrToEle",value:function(t,e,n,r,i,o){var c=this;return new Promise(function(a,u){var l=function t(e,n,u){if(!n.length||"nope"===c._status)return void a();var l=e.innerHTML;f().then(function(){return h(u)}).then(function(){c._paused?t(e,n,u):(r&&";"===n[0]&&c._applyStyle(r,i,o),s(e,l+=n[0]),c._fixScrollTop(),n.splice(0,1),t(e,n,u))})};l(t,e,n)})}},{key:"_fixScrollTop",value:function(){var t=this.codeCon;t.scrollTop=t.scrollHeight}},{key:"_onChange",value:function(t,e){"Function"===p(this.options.onChange)&&this.options.onChange(t,e)}},{key:"_init",value:function(){var t=this;if(!this.codeCon)return void console.warn('You should give a real element to options of "codeCon".');if(0===this._index&&(this._status="start",this._block=!0,this._onChange("start")),"nope"===this._status)return this._index=0,this._block=!1,void y.trigger("nope");if(this._index>=this._formatedArray.length)return this._status="stop",this._block=!1,this._onChange("stop"),void(this._status="nope");var e=this._formatedArray[this._index];this._status="processing",this._handler(e).then(function(){t._index++,t._init()})}},{key:"init",value:function(){this._init()}},{key:"format",value:function(){return this._formatedArray=t(this.source),this._formatedArray}},{key:"setOptions",value:function(t){return this._block?void console.warn("Print process is running. Please wait it stop or apply stop func."):(this.constructor(t),void this.init())}},{key:"pause",value:function(){this._paused=!0}},{key:"continue",value:function(){this._paused=!1}},{key:"toggle",value:function(){this._paused=!this._paused}},{key:"stop",value:function(t){var e=this;return new Promise(function(n,r){e._block||("Function"===p(t)&&t(),n()),e._status="nope",y.on("nope",function(){"Function"===p(t)&&t(),y.off("nope"),n()})})}}]),e}();return g});