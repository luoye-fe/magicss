/*
 * Magicss v1.0.0
 * (c) 2016 luoye <842891024@qq.com>
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Magicss=e()}(this,function(){"use strict";function t(t){function e(e){return c=e?c+e:++c,u=t.charAt(c),u||""}function n(){return t.charAt(c+1)||""}function r(){var n=t.substr(c),r=n.match(l.comment)[0];for(e(r.length);/\s|\n/.test(u);)r+=u,e();var i={};if(l.ruleOptionInComment.test(r)){var o=r.match(l.ruleOptionInComment)[1];i=a(o)}s.push({type:"comment",comment:r.replace(l.ruleOptionInComment,""),options:i})}function i(){var n=t.substr(c),r=n.match(l.selector)[1];e(r.length);var i=o();s.push({type:"common",selector:r.replace(l.bothWhiteSpace,""),options:i.options,style:i.style})}function o(){var n=t.substr(c),r=n.match(l.allRules)[1],i={},o={};if(e(r.length),l.comment.test(r)){var s=r.match(l.comment)[0].replace(l.whiteSpace,"").replace(l.commentFlag,"").replace(/\n/g,"");i=a(s)}var u=r.replace(l.comment,"").replace(/\n/g,"").replace(/\{|\}/g,"");return o=a(u),{options:i,style:o}}function a(t){var e={},n=h(t,";");return n.forEach(function(t){var n=h(t,":");e[n[0].replace(l.bothWhiteSpace,"")]=n[1].replace(l.bothWhiteSpace,"")}),e}var s=[];t=t||"",t=t.replace(/\r\n|[\r\u2028\u2029]/g,"\n");var c=-1,u=void 0,l={};l.comment=/\/\*[\s\S]+?\*\/|\/\/.+?\n/,l.commentFlag=/\/\/|\/\*|\*\//g,l.ruleOptionInComment=/\{\{(.+?)\}\}/,l.bothWhiteSpace=/^\s+|\s+$/,l.whiteSpace=/\s/g,l.selector=/([\s\S]+?)\{/,l.allRules=/(\{[\s\S]+?\})/;var f=["a","abbr","acronym","address","applet","area","article","aside","audio","b","base","basefont","bdi","bdo","bgsound","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","command","content","data","datalist","dd","del","details","dfn","dialog","dir","div","dl","dt","element","em","embed","fieldset","figcaption","figure","font","footer","form","frame","frameset","head","header","hgroup","hr","html","i","iframe","image","img","input","ins","isindex","kbd","keygen","label","legend","li","link","listing","main","map","mark","marquee","menu","menuitem","meta","meter","multicol","nav","nobr","noembed","noframes","noscript","object","ol","optgroup","option","output","p","param","picture","plaintext","pre","progress","q","rp","rt","rtc","ruby","s","samp","script","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","tt","u","ul","var","video","wbr","xmp"],p=["*",".","#","[",":"],d=[];for(d=[].concat(p),f.forEach(function(t){var e=t.substr(0,1);d.includes(e)||d.push(e)}),e();;){if(!u)break;"/"!==u||"*"!==n()&&"/"!==n()?d.includes(u)?i():e():r()}return s}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){for(var n,r=0;r<t.length;r++){var i=t[r];n=e.call(i,r,i)}return n}function i(t){return document.querySelector(t)}function o(t,e,n){var r=document.createElement(t),i=void 0;for(i in e)e.hasOwnProperty(i)&&r.setAttribute(i,e[i]);return n&&s(r,n),r}function a(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];n.forEach(function(e){t.appendChild(e)})}function s(t,e){c(e,0,t)}function c(t,e){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];r.forEach(function(n){e?"string"==typeof n.textContent?n.textContent=t:n.innerText=t:n.innerHTML=t})}function u(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var h=function(t,e){e=e||"";var n=t.split(e);return n[n.length-1].replace(/(^\s*)|(\s*$)/g,"").length||n.pop(),n},l=function(t){return new Promise(function(e,n){setTimeout(function(){e()},parseInt(t))})},f=function(t){return JSON.parse(JSON.stringify(t))},p=function(){return new Promise(function(t,e){t()})},d=function(t){return Object.prototype.toString.call(t).match(/\[object\s(.+?)]/)[1]},m=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),v=function(){function t(){n(this,t),this.cache={},this.offlineCache=[],this.isOne=!1}return m(t,[{key:"on",value:function(t,n){void 0===this.cache[t]?(this.cache[t]=[],this.cache[t].push(n)):this.cache[t].push(n);var i=[];r(this.offlineCache,function(e,n){if(void 0!==n[t]){var r={};r[t]=n[t],i.push(r)}}),i.length>0&&(this.isOne?e.trigger(t,i[i.length-1][t]):r(i,function(n,r){e.trigger(t,r[t])}))}},{key:"one",value:function(t,e){this.isOne=!0,this.on(t,e),this.isOne=!1}},{key:"off",value:function(t,e){this.cache[t]&&(e?(e&&e(),this.cache[t]=[]):this.cache[t]=[]),this.offlineCache=[]}},{key:"trigger",value:function(t,e){var n=this.cache[t];if(!n||!n.length){var i={};return i[t]=e,void this.offlineCache.push(i)}return this.isOne?(n[0].call(this,e),void(this.cache[t]=[])):r(n,function(){return this.call(this,e)})}}]),t}(),g=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),y={speed:50,delay:0},_=new v,b=function(){function e(t){u(this,e),this.options=t||{},this.source=this.options.source||"",this.codeCon=this.options.codeCon||!1,this._paused=!1,this._status="nope",this._formatedArray=[],this._index=0,this.format()}return g(e,[{key:"_assignPrintOption",value:function(t){return Object.assign(f(y),t)}},{key:"_handler",value:function(t){var e=this;return new Promise(function(n,r){"nope"===e._status&&n();var i=e._assignPrintOption(t.options);p().then(function(){return l(i.delay)}).then(function(){return e._print(t)}).then(function(){n()})})}},{key:"_applyStyle",value:function(t,e,n){i("#Magicss-style-con")||a(i("head"),o("style",{id:"Magicss-style-con"}));var r=i("#Magicss-style-con"),c=r.innerHTML;s(r,c+=t+"{"+e+":"+n+"}")}},{key:"_insertElement",value:function(t){var e=o("span",{class:t});return a(this.codeCon,e),e}},{key:"_print",value:function(t,e){var n=this;return this._onChange("processing",t),new Promise(function(e,r){"nope"===n._status&&e(),"comment"===t.type?!function(){var r=n._assignPrintOption(t.options);p().then(function(){var e=h(t.comment,""),i=n._insertElement("comment");return n._writeCharacterArrToEle(i,e,r.speed)}).then(function(){var t=["\n"],e=n.codeCon;return n._writeCharacterArrToEle(e,t,r.speed)}).then(function(){e()})}():"common"===t.type&&!function(){var r=n._assignPrintOption(t.options);p().then(function(){var e=h(t.selector,""),i=n._insertElement("selector");return n._writeCharacterArrToEle(i,e,r.speed)}).then(function(){var t=[" ","{","\n"],e=n.codeCon;return n._writeCharacterArrToEle(e,t,r.speed)}).then(function(){var e=Object.keys(t.style),i=0;return new Promise(function(o,a){var s=function a(){if(i>=e.length||"nope"===n._status)return void o();var s=n.codeCon;n._writeCharacterArrToEle(s,[" "," "," "," "],r.speed).then(function(){var t=h(e[i],""),o=n._insertElement("key");return n._writeCharacterArrToEle(o,t,r.speed)}).then(function(){return n._writeCharacterArrToEle(s,[":"," "],r.speed)}).then(function(){var o=h(t.style[e[i]],""),a=n._insertElement("value");return n._writeCharacterArrToEle(a,o,r.speed)}).then(function(){var o=e[i],a=t.style[e[i]];return n._writeCharacterArrToEle(s,[";","\n"],r.speed,t.selector,o,a)}).then(function(){i++,a()})};s()})}).then(function(){var t=["}","\n\n"],e=n.codeCon;return n._writeCharacterArrToEle(e,t,r.speed)}).then(function(){e()})}()})}},{key:"_writeCharacterArrToEle",value:function(t,e,n,r,i,o){var a=this;return new Promise(function(c,u){var h=function t(e,n,u){if(!n.length||"nope"===a._status)return void c();var h=e.innerHTML;p().then(function(){return l(u)}).then(function(){a._paused?t(e,n,u):("\n"===n[0]&&a._fixScrollTop(),r&&";"===n[0]&&a._applyStyle(r,i,o),s(e,h+=n[0]),n.splice(0,1),t(e,n,u))})};h(t,e,n)})}},{key:"_fixScrollTop",value:function(){var t=this.codeCon;t.scrollTop=t.scrollHeight}},{key:"_onChange",value:function(t,e){"Function"===d(this.options.onChange)&&this.options.onChange(t,e)}},{key:"_init",value:function(){var t=this;if(!this.codeCon)return void console.warn('You should give a real element to options of "codeCon".');if(0===this._index&&(this._status="start",this._onChange("start")),"nope"===this._status)return this._index=0,void _.trigger("nope");if(this._index>=this._formatedArray.length)return this._status="stop",this._onChange("stop"),void(this._status="nope");var e=this._formatedArray[this._index];this._status="processing",this._handler(e).then(function(){t._index++,t._init()})}},{key:"init",value:function(){this._init()}},{key:"format",value:function(){return this._formatedArray=t(this.source),this._formatedArray}},{key:"setOptions",value:function(t){var e=this;return"nope"===this._status?(this.constructor(t),void this.init()):(this.constructor(t),void _.on("nope",function(){e.init()}))}},{key:"pause",value:function(){this._paused=!0}},{key:"continue",value:function(){this._paused=!1}},{key:"toggle",value:function(){this._paused=!this._paused}}]),e}();return b});