/*
 * Magicss v1.0.0
 * (c) 2016 luoye <842891024@qq.com>
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Magicss=e()}(this,function(){"use strict";function t(t){function e(e){return u=e?u+e:++u,h=t.charAt(u),h||""}function n(){return t.charAt(u+1)||""}function r(){var n=t.substr(u),r=n.match(l.comment)[0];for(e(r.length);/\s|\n/.test(h);)r+=h,e();var i={};if(l.ruleOptionInComment.test(r)){var o=r.match(l.ruleOptionInComment)[1];i=a(o)}c.push({type:"comment",comment:r.replace(l.ruleOptionInComment,""),options:i})}function i(){var n=t.substr(u),r=n.match(l.selector)[1];e(r.length);var i=o();c.push({type:"common",selector:r.replace(l.bothWhiteSpace,""),options:i.options,style:i.style})}function o(){var n=t.substr(u),r=n.match(l.allRules)[1],i={},o={};if(e(r.length),l.comment.test(r)){var s=r.match(l.comment)[0].replace(l.whiteSpace,"").replace(l.commentFlag,"").replace(/\n/g,"");i=a(s)}var c=r.replace(l.comment,"").replace(/\n/g,"").replace(/\{|\}/g,"");return o=a(c),{options:i,style:o}}function a(t){var e={},n=s(t,";");return n.forEach(function(t){var n=s(t,":");e[n[0].replace(l.bothWhiteSpace,"")]=n[1].replace(l.bothWhiteSpace,"")}),e}var c=[];t=t||"",t=t.replace(/\r\n|[\r\u2028\u2029]/g,"\n");var u=-1,h=void 0,l={};l.comment=/\/\*[\s\S]+?\*\/|\/\/.+?\n/,l.commentFlag=/\/\/|\/\*|\*\//g,l.ruleOptionInComment=/\{\{(.+?)\}\}/,l.bothWhiteSpace=/^\s+|\s+$/,l.whiteSpace=/\s/g,l.selector=/([\s\S]+?)\{/,l.allRules=/(\{[\s\S]+?\})/;var f=["a","abbr","acronym","address","applet","area","article","aside","audio","b","base","basefont","bdi","bdo","bgsound","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","command","content","data","datalist","dd","del","details","dfn","dialog","dir","div","dl","dt","element","em","embed","fieldset","figcaption","figure","font","footer","form","frame","frameset","head","header","hgroup","hr","html","i","iframe","image","img","input","ins","isindex","kbd","keygen","label","legend","li","link","listing","main","map","mark","marquee","menu","menuitem","meta","meter","multicol","nav","nobr","noembed","noframes","noscript","object","ol","optgroup","option","output","p","param","picture","plaintext","pre","progress","q","rp","rt","rtc","ruby","s","samp","script","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","tt","u","ul","var","video","wbr","xmp"],p=["*",".","#","[",":"],d=[];for(d=[].concat(p),f.forEach(function(t){var e=t.substr(0,1);d.includes(e)||d.push(e)}),e();;){if(!h)break;"/"!==h||"*"!==n()&&"/"!==n()?d.includes(h)?i():e():r()}return c}function e(t){return document.querySelector(t)}function n(t,e,n){var r=document.createElement(t),o=void 0;for(o in e)e.hasOwnProperty(o)&&r.setAttribute(o,e[o]);return n&&i(r,n),r}function r(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];n.forEach(function(e){t.appendChild(e)})}function i(t,e){o(e,0,t)}function o(t,e){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];r.forEach(function(n){e?"string"==typeof n.textContent?n.textContent=t:n.innerText=t:n.innerHTML=t})}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var s=function(t,e){e=e||"";var n=t.split(e);return n[n.length-1].replace(/(^\s*)|(\s*$)/g,"").length||n.pop(),n},c=function(t){return new Promise(function(e,n){setTimeout(function(){e()},parseInt(t))})},u=function(t){return JSON.parse(JSON.stringify(t))},h=function(){return new Promise(function(t,e){t()})},l=function(t){return Object.prototype.toString.call(t).match(/\[object\s(.+?)]/)[1]},f={},p=function(t,e){for(var n,r=0;r<t.length;r++){var i=t[r];n=e.call(i,r,i)}return n};f.cache={},f.offlineCache=[],f.isOne=!1,f.on=function(t,e){var n=this;void 0===this.cache[t]?(this.cache[t]=[],this.cache[t].push(e)):this.cache[t].push(e);var r=[];p(this.offlineCache,function(e,n){if(void 0!==n[t]){var i={};i[t]=n[t],r.push(i)}}),r.length>0&&(n.isOne?f.trigger(t,r[r.length-1][t]):p(r,function(e,n){f.trigger(t,n[t])}))},f.one=function(t,e){this.isOne=!0,this.on(t,e),this.isOne=!1},f.off=function(t,e){this.cache[t]&&(e?(e&&e(),this.cache[t]=[]):this.cache[t]=[]),this.offlineCache=[]},f.trigger=function(t,e){var n=this,r=this.cache[t];if(!r||!r.length){var i={};return i[t]=e,void this.offlineCache.push(i)}return this.isOne?(r[0].call(n,e),void(this.cache[t]=[])):p(r,function(){return this.call(n,e)})};var d=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),m={speed:50,delay:0},v=function(){function o(t){a(this,o),this.options=t||{},this.source=this.options.source||"",this.codeCon=this.options.codeCon||!1,this._paused=!1,this._status="nope",this._formatedArray=[],this._index=0,this.format()}return d(o,[{key:"_assignPrintOption",value:function(t){return Object.assign(u(m),t)}},{key:"_handler",value:function(t){var e=this;return new Promise(function(n,r){"nope"===e._status&&n();var i=e._assignPrintOption(t.options);h().then(function(){return c(i.delay)}).then(function(){return e._print(t)}).then(function(){n()})})}},{key:"_applyStyle",value:function(t,o,a){e("#Magicss-style-con")||r(e("head"),n("style",{id:"Magicss-style-con"}));var s=e("#Magicss-style-con"),c=s.innerHTML;i(s,c+=t+"{"+o+":"+a+"}")}},{key:"_insertElement",value:function(t){var e=n("span",{class:t});return r(this.codeCon,e),e}},{key:"_print",value:function(t,e){var n=this;return this._onChange("processing",t),new Promise(function(e,r){"nope"===n._status&&e(),"comment"===t.type?!function(){var r=n._assignPrintOption(t.options);h().then(function(){var e=s(t.comment,""),i=n._insertElement("comment");return n._writeCharacterArrToEle(i,e,r.speed)}).then(function(){var t=["\n"],e=n.codeCon;return n._writeCharacterArrToEle(e,t,r.speed)}).then(function(){e()})}():"common"===t.type&&!function(){var r=n._assignPrintOption(t.options);h().then(function(){var e=s(t.selector,""),i=n._insertElement("selector");return n._writeCharacterArrToEle(i,e,r.speed)}).then(function(){var t=[" ","{","\n"],e=n.codeCon;return n._writeCharacterArrToEle(e,t,r.speed)}).then(function(){var e=Object.keys(t.style),i=0;return new Promise(function(o,a){var c=function a(){if(i>=e.length||"nope"===n._status)return void o();var c=n.codeCon;n._writeCharacterArrToEle(c,[" "," "," "," "],r.speed).then(function(){var t=s(e[i],""),o=n._insertElement("key");return n._writeCharacterArrToEle(o,t,r.speed)}).then(function(){return n._writeCharacterArrToEle(c,[":"," "],r.speed)}).then(function(){var o=s(t.style[e[i]],""),a=n._insertElement("value");return n._writeCharacterArrToEle(a,o,r.speed)}).then(function(){var o=e[i],a=t.style[e[i]];return n._writeCharacterArrToEle(c,[";","\n"],r.speed,t.selector,o,a)}).then(function(){i++,a()})};c()})}).then(function(){var t=["}","\n\n"],e=n.codeCon;return n._writeCharacterArrToEle(e,t,r.speed)}).then(function(){e()})}()})}},{key:"_writeCharacterArrToEle",value:function(t,e,n,r,o,a){var s=this;return new Promise(function(u,l){var f=function t(e,n,l){if(!n.length||"nope"===s._status)return void u();var f=e.innerHTML;h().then(function(){return c(l)}).then(function(){s._paused?t(e,n,l):("\n"===n[0]&&s._fixScrollTop(),r&&";"===n[0]&&s._applyStyle(r,o,a),i(e,f+=n[0]),n.splice(0,1),t(e,n,l))})};f(t,e,n)})}},{key:"_fixScrollTop",value:function(){var t=this.codeCon;t.scrollTop=t.scrollHeight}},{key:"_onChange",value:function(t,e){"Function"===l(this.options.onChange)&&this.options.onChange(t,e)}},{key:"_init",value:function(){var t=this;if(!this.codeCon)return void console.warn('You should give a real element to options of "codeCon".');if(0===this._index&&(this._status="start",this._onChange("start")),"nope"===this._status)return this._index=0,void f.trigger("nope");if(this._index>=this._formatedArray.length)return this._status="stop",void this._onChange("stop");var e=this._formatedArray[this._index];this._status="processing",this._handler(e).then(function(){t._index++,t._init()})}},{key:"init",value:function(){this._init()}},{key:"format",value:function(){return this._formatedArray=t(this.source),this._formatedArray}},{key:"setOptions",value:function(t){var e=this;this.constructor(t),f.on("nope",function(){e._init()})}},{key:"pause",value:function(){this._paused=!0}},{key:"continue",value:function(){this._paused=!1}},{key:"toggle",value:function(){this._paused=!this._paused}}]),o}();return v});